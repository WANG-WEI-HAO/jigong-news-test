<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>濟公報</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#5a4fcf"/>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <!-- Favicon & PWA Tags -->
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="icons/濟公報logo.png">
  <link rel="shortcut icon" href="icons/濟公報logo.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes"> 
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="濟公報">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512.png"> <!-- Retain 512px icon from old code -->

  <!-- OG Preview -->
  <meta property="og:title" content="濟公報">
  <meta property="og:description" content="濟公報(每日7:00更新)安裝至桌面可開啟推播通知">
  <meta property="og:image" content="https://wang-wei-hao.github.io/jigong-news/icons/icon-512.png">
  <meta property="og:url" content="https://wang-wei-hao.github.io/jigong-news/">
  
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-4EBM386ZCS"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-4EBM386ZCS');
  </script>

  <style>
    :root {
        --primary-color: #5a4fcf;
        --primary-color-dark: #bb86fc; /* Slightly lighter purple for dark mode accents */
        --background-light: #f9f9f9;
        --background-dark: #121212;
        --surface-light: #ffffff;
        --surface-dark: #1e1e1e;
        --text-light: #212529;
        --text-dark: #e0e0e0;
        --text-muted-light: #6c757d;
        --text-muted-dark: #aaa;
        --border-light: #e9ecef;
        --border-dark: #333;
    }
    
    /* --- 基本設定 --- */
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      padding: 2rem; 
      background: var(--background-light); 
      color: var(--text-light);
      transition: background-color 0.3s, color 0.3s; 
      -webkit-tap-highlight-color: transparent; 
    }
    body.dark-mode {
        background: var(--background-dark);
        color: var(--text-dark);
    }

    h1 { color: var(--primary-color); }
    body.dark-mode h1 { color: var(--primary-color-dark); }
    h1 .subtitle { font-size: 0.6em; font-weight: normal; color: var(--text-muted-light); margin-left: 0.5em; }
    body.dark-mode h1 .subtitle { color: var(--text-muted-dark); }

    /* --- 內容與卡片 (CSS Grid) --- */
    #content {
      display: grid;
      gap: 1.5rem; /* 預設間距 */
      grid-template-columns: 1fr; /* 預設為單欄，適用於手機和窄螢幕 */
    }
    /* 預設響應式佈局 (如果沒有明確的用戶偏好) */
    @media (min-width: 701px) { #content { grid-template-columns: repeat(2, 1fr); } }
    @media (min-width: 1025px) { #content { grid-template-columns: repeat(3, 1fr); } }
    @media (min-width: 1400px) { #content { grid-template-columns: repeat(4, 1fr); } }

    /* 根據 body 上的 class 覆蓋預設響應式布局 (用戶偏好) */
    body.layout-1-col #content { grid-template-columns: 1fr !important; }
    @media (min-width: 701px) { body.layout-2-col #content { grid-template-columns: repeat(2, 1fr) !important; } }
    @media (min-width: 1025px) { body.layout-3-col #content { grid-template-columns: repeat(3, 1fr) !important; } }
    @media (min-width: 1400px) { body.layout-4-col #content { grid-template-columns: repeat(4, 1fr) !important; } }
    
    /* 在手機或窄螢幕下 (max-width: 700px)，強制為一欄，覆蓋所有用戶偏好 */
    @media (max-width: 700px) { #content { grid-template-columns: 1fr !important; } }
    
    .post { 
      background: var(--surface-light); 
      padding: 1.25rem; 
      border-radius: 12px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
      transition: all 0.3s;
      border: 1px solid var(--border-light);
    }
    body.dark-mode .post {
        background: var(--surface-dark);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        border-color: var(--border-dark);
    }
    .post:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }
    body.dark-mode .post:hover {
        box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }

    .date { font-size: 0.9em; color: var(--text-muted-light); margin-bottom: 0.5rem; }
    body.dark-mode .date { color: var(--text-muted-dark); }
    .text { margin-top: 0.5em; line-height: 1.6; }
    img { max-width: 100%; margin-top: 1em; border-radius: 8px; cursor: zoom-in; }

    /* --- 輸入與按鈕 --- */
    .input-row { display: flex; gap: 1em; margin-bottom: 2em; align-items: center; flex-wrap: wrap; }
    #search, #datePicker {
      padding: 0.75em; font-size: 1em; border: 1px solid #ccc; border-radius: 8px; transition: all 0.2s;
      background-color: var(--surface-light); color: var(--text-light);
    }
    body.dark-mode #search, body.dark-mode #datePicker {
        background-color: #2c2c2c; color: var(--text-dark); border-color: #444;
    }
    #search:focus, #datePicker.open { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(90, 79, 207, 0.2); outline: none; }
    body.dark-mode #search:focus, body.dark-mode #datePicker.open { border-color: var(--primary-color-dark); box-shadow: 0 0 0 3px rgba(187, 134, 252, 0.2); }

    .action-button, #loadMoreBtn, .reset-btn, #todayBtn {
        padding: 0.75em 1.5em; font-size: 1em; border-radius: 8px; cursor: pointer;
        border: none; transition: all 0.2s; font-weight: 500;
    }
    .action-button:active, #loadMoreBtn:active, .reset-btn:active, #todayBtn:active { transform: scale(0.97); }
    #loadMoreBtn { display: none; margin: 2rem auto; background: var(--primary-color); color: white; }
    .reset-btn { background: none; font-size: 1.5em; color: var(--primary-color); padding: 0.2em 0.5em; }
    #todayBtn { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 999; background: #28a745; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .footer { text-align: center; padding: 15px 0; margin-top: 20px; border-top: 1px solid var(--border-light); color: var(--text-muted-light); font-size: 0.9em; }
    body.dark-mode .footer { border-top-color: var(--border-dark); color: var(--text-muted-dark); }

    /* --- 設定面板 --- */
    .settings-button {
      position: fixed; top: 1.5rem; right: 1.5rem; background: none; border: none; font-size: 1.8em;
      color: var(--primary-color); cursor: pointer; z-index: 10001; transition: transform 0.2s;
    }
    body.dark-mode .settings-button { color: var(--primary-color-dark); }
    .settings-button:active { transform: scale(0.95); }

    .overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px); z-index: 9998; opacity: 0; pointer-events: none; transition: opacity 0.3s ease-out;
    }
    .overlay.is-visible { opacity: 1; pointer-events: auto; }

    .settings-panel {
      position: fixed; top: 0; right: -320px; width: min(320px, 90vw); height: 100%;
      background-color: var(--background-light); box-shadow: -5px 0 25px rgba(0, 0, 0, 0.15);
      z-index: 10000; transition: right 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      display: flex; flex-direction: column;
    }
    body.dark-mode .settings-panel { background-color: #212121; }
    .settings-panel.is-open { right: 0; }
    .settings-header { display: flex; justify-content: space-between; align-items: center; padding: 1.25rem; border-bottom: 1px solid var(--border-light); }
    body.dark-mode .settings-header { border-bottom-color: var(--border-dark); }
    .settings-header h2 { margin: 0; font-size: 1.5em; }
    .settings-content { padding: 1.25rem; flex-grow: 1; overflow-y: auto; }
    .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid var(--border-light); }
    .setting-item:last-child { border-bottom: none; }
    body.dark-mode .setting-item { border-bottom-color: var(--border-dark); }
    .setting-item label { font-size: 1.1em; font-weight: 500; margin-right: 1rem; }
    #clear-cache-btn { background-color: #ffc107; color: #212529; }
    .close-button {
      background: none; border: none; font-size: 1.8em; color: var(--text-muted-light);
      cursor: pointer; line-height: 1; transition: color 0.2s, transform 0.2s;
    }
    .close-button:hover { color: var(--text-light); transform: rotate(90deg); }
    body.dark-mode .close-button { color: var(--text-muted-dark); }
    body.dark-mode .close-button:hover { color: var(--text-dark); }

    /* --- 精緻化 Toggle Switch --- */
    .toggle-switch {
      position: relative; width: 100px; height: 38px; display: inline-block; flex-shrink: 0;
    }
    .toggle-switch-checkbox { display: none; }
    .toggle-switch-label {
      display: block; overflow: hidden; cursor: pointer; border-radius: 20px;
      background-color: #ccc; transition: background-color 0.3s ease;
      position: relative; width: 100%; height: 100%;
    }
    body.dark-mode .toggle-switch-label { background-color: #555; }
    .toggle-switch-checkbox:checked + .toggle-switch-label { background-color: #28a745; }
    #themeToggleSwitch:checked + .toggle-switch-label { background-color: var(--primary-color-dark); } 
    
    .toggle-switch-inner {
      display: block; width: 200%; margin-left: -100%; transition: margin 0.3s ease-in-out;
    }
    .toggle-switch-inner:before, .toggle-switch-inner:after {
      display: block; float: left; width: 50%; height: 38px; line-height: 38px;
      font-size: 14px; color: white; font-weight: bold; box-sizing: border-box;
      text-align: center;
    }
    /* 推播通知開關文字 */
    #notificationToggle + .toggle-switch-label .toggle-switch-inner:before { content: attr(data-on); padding-right: 10px; text-align: left; }
    #notificationToggle + .toggle-switch-label .toggle-switch-inner:after { content: attr(data-off); padding-left: 10px; text-align: right; color: #333;}
    /* 主題開關文字 */
    #themeToggleSwitch + .toggle-switch-label .toggle-switch-inner:before { content: attr(data-on); padding-right: 10px; text-align: left; background-color: var(--primary-color-dark); }
    #themeToggleSwitch + .toggle-switch-label .toggle-switch-inner:after { content: attr(data-off); padding-left: 10px; text-align: right; color: #333; }
    body.dark-mode #themeToggleSwitch + .toggle-switch-label .toggle-switch-inner:after { color: white; }

    .toggle-switch-checkbox:checked + .toggle-switch-label .toggle-switch-inner { margin-left: 0; }
    
    .toggle-switch-switch {
      display: block; width: 30px; height: 30px; background: white;
      position: absolute; top: 4px; left: 4px; border-radius: 50%;
      transition: left 0.3s ease-in-out; box-shadow: 0 1px 3px rgba(0,0,0,0.4);
    }
    .toggle-switch-checkbox:checked + .toggle-switch-label .toggle-switch-switch { left: calc(100% - 34px); }
    .toggle-switch-checkbox:disabled + .toggle-switch-label { opacity: 0.5; cursor: not-allowed; }

    /* --- 通用自訂模態框 --- */
    .custom-prompt-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
        z-index: 10000; display: flex; justify-content: center; align-items: center;
        opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0s 0.3s;
    }
    .custom-prompt-overlay.visible {
        opacity: 1; visibility: visible; transition: opacity 0.3s, visibility 0s;
    }
    .custom-prompt {
        background-color: var(--surface-light); color: var(--text-light);
        padding: 2rem; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        font-size: 1.1em; text-align: center; width: clamp(320px, 90vw, 500px);
        transform: scale(0.95) translateY(10px); opacity: 0;
        transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.3s;
        position: relative; display: flex; flex-direction: column; gap: 1rem;
    }
    .custom-prompt-overlay.visible .custom-prompt {
        transform: scale(1) translateY(0); opacity: 1;
    }
    body.dark-mode .custom-prompt {
        background-color: #2c2c2c; color: var(--text-dark);
    }
    .custom-prompt .close-button { position: absolute; top: 1rem; right: 1rem; }
    .custom-prompt p { margin: 0; }
    .custom-prompt .button-group { display: flex; justify-content: center; gap: 1rem; margin-top: 1rem; }
    .custom-prompt button { padding: 0.75em 1.5em; border-radius: 8px; font-size: 1em; }
    .custom-prompt .primary-action { background-color: var(--primary-color); color: white; border: none;}
    body.dark-mode .custom-prompt .primary-action { background-color: var(--primary-color-dark); color: var(--background-dark); }
    .custom-prompt .secondary-action { background-color: #e9ecef; color: #333; border: none;}
    body.dark-mode .custom-prompt .secondary-action { background-color: #555; color: white; }
    #customInstallPrompt img { height: 1.2em; vertical-align: middle; margin: 0 0.2em; display: inline-block; }
    
    /* --- 圖片大圖 Modal --- */
    #imageModal {
      display: none; position: fixed; z-index: 10001; top: 0; left: 0;
      width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.85);
      justify-content: center; align-items: center;
    }
    #imageModal img {
      max-width: 90vw; max-height: 90vh; border-radius: 10px;
      box-shadow: 0 0 30px black;
    }
    .modal-nav-btn {
      position: absolute; top: 50%; transform: translateY(-50%);
      font-size: 3em; color: white; background-color: rgba(0,0,0,0.3);
      border: none; cursor: pointer; padding: 0.3em 0.6em; z-index: 10002; 
      border-radius: 8px; opacity: 0; transition: opacity 0.3s;
    }
    #imageModal:hover .modal-nav-btn { opacity: 1; }
    #modalPrevBtn { left: 40px; }
    #modalNextBtn { right: 40px; }
    #shareButtonsContainer {
      position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%);
      background-color: rgba(30, 30, 30, 0.85); padding: 10px 15px; border-radius: 8px;
      display: flex; gap: 12px; z-index: 10002; opacity: 0; transition: opacity 0.3s;
    }
    #imageModal:hover #shareButtonsContainer { opacity: 1; }
    #shareButtonsContainer button, #shareButtonsContainer a {
      background-color: transparent; color: #f0f0f0; border: none; border-radius: 5px;
      cursor: pointer; text-decoration: none; display: inline-flex; align-items: center;
      transition: background-color 0.2s, transform 0.1s; padding: 6px 10px;
    }
    #shareButtonsContainer button:hover, #shareButtonsContainer a:hover { background-color: rgba(255, 255, 255, 0.1); }
    #shareButtonsContainer button:active, #shareButtonsContainer a:active { transform: scale(0.95); }
    #shareButtonsContainer .share-btn-icon { width: 25px; height: 25px; cursor: pointer; border-radius: 4px; overflow: hidden; }

    /* --- 排版按鈕 --- */
    .layout-options { display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; width: 100%; }
    .layout-option-btn {
      padding: 8px 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #f0f0f0;
      color: #333; cursor: pointer; transition: all 0.2s; flex-grow: 1; text-align: center;
    }
    .layout-option-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
    body.dark-mode .layout-option-btn { background-color: #3c3c3c; color: #eee; border-color: #555; }
    body.dark-mode .layout-option-btn.active { background-color: var(--primary-color-dark); color: var(--background-dark); border-color: var(--primary-color-dark); }
  </style>
</head>

<body>
  <header>
    <h1>濟公報<span class="subtitle">（每日7:00更新）</span></h1>
  </header>
  
  <button id="todayBtn" title="回到頂部">↑</button>
  <button id="settings-btn" class="settings-button" title="設定">⚙️</button>

  <main id="app-content">
    <div class="input-row">
      <input id="search" type="text" placeholder="搜尋內容..." />
      <input id="datePicker" type="text" placeholder="選擇日期..." readonly />
      <button id="resetBtn" class="reset-btn" title="重設篩選">↻</button>
    </div>
    
    <div id="gacha-game-container"></div>
    
    <div id="content"></div>
    <button id="loadMoreBtn">顯示更多</button>
  </main>
  
  <div class="overlay"></div>

  <!-- 設定面板 -->
  <div id="settings-panel" class="settings-panel">
    <div class="settings-header">
      <h2>設定</h2>
      <button id="close-settings-btn" class="close-button" title="關閉設定">×</button>
    </div>
    <div class="settings-content">
      <div class="setting-item">
        <label for="notificationToggle">推播通知</label>
        <div class="toggle-switch">
          <input type="checkbox" id="notificationToggle" class="toggle-switch-checkbox" disabled>
          <label for="notificationToggle" class="toggle-switch-label">
            <span class="toggle-switch-inner" data-on="開啟" data-off="關閉"></span>
            <span class="toggle-switch-switch"></span>
          </label>
        </div>
      </div>
      <div class="setting-item">
        <label for="themeToggleSwitch">系統背景</label>
        <div class="toggle-switch">
          <input type="checkbox" id="themeToggleSwitch" class="toggle-switch-checkbox">
          <label for="themeToggleSwitch" class="toggle-switch-label" data-on="深色" data-off="淺色">
            <span class="toggle-switch-inner"></span>
            <span class="toggle-switch-switch"></span>
          </label>
        </div>
      </div>
      <div class="setting-item" style="flex-direction: column; align-items: flex-start;">
        <label style="margin-bottom: 0.75rem;">排版方式</label>
        <div id="layout-options" class="layout-options">
          <button class="layout-option-btn" data-layout="layout-1-col">一欄</button>
          <button class="layout-option-btn" data-layout="layout-2-col">兩欄</button>
          <button class="layout-option-btn" data-layout="layout-3-col">三欄</button>
          <button class="layout-option-btn" data-layout="layout-4-col">四欄</button>
        </div>
      </div>
      <div class="setting-item">
        <label>清除網站快取</label>
        <button id="clear-cache-btn" class="action-button">立即清除</button>
      </div>
    </div>
  </div>

  <!-- 圖片 Modal -->
  <div id="imageModal">
    <button id="modalCloseBtn" class="close-button" style="position:absolute; top: 1rem; right: 1rem;" title="關閉">×</button>
    <button id="modalPrevBtn" class="modal-nav-btn" title="上一張"><</button>
    <img alt="放大圖片" id="modalImage">
    <button id="modalNextBtn" class="modal-nav-btn" title="下一張">></button>
    <div id="shareButtonsContainer"></div>
  </div>

  <!-- PWA 安裝提示 (內容由 JS 動態生成) -->
  <div id="customInstallPromptOverlay" class="custom-prompt-overlay"></div>

  <!-- 通知確認 Modal -->
  <div id="notificationConfirmationModalOverlay" class="custom-prompt-overlay">
    <div id="notificationConfirmationModal" class="custom-prompt">
        <p style="font-weight: bold;">開啟推播通知？</p>
        <p style="font-size: 0.95em; opacity: 0.9;">即可每日收到最新的濟公報更新。</p>
        <div class="button-group">
            <button id="cancelEnableNotificationsButton" class="secondary-action">取消</button>
            <button id="confirmEnableNotificationsButton" class="primary-action">開啟通知</button>
        </div>
        <button id="notificationConfirmationCloseXButton" class="close-button">×</button>
    </div>
  </div>

  <!-- 權限被拒絕指引 Modal -->
  <div id="permissionDeniedModalOverlay" class="custom-prompt-overlay">
    <div id="permissionDeniedModal" class="custom-prompt">
        <p style="font-weight: bold;">通知權限被拒絕</p>
        <p style="font-size: 0.9em; opacity: 0.9;">請至您的**瀏覽器設定**中，手動允許本網站的通知權限。</p>
        <div class="button-group">
            <button id="permissionDeniedCloseButton" class="primary-action">我知道了</button>
        </div>
        <button id="permissionDeniedCloseXButton" class="close-button">×</button>
    </div>
  </div>

  <!-- 通用確認 Modal (取代 confirm) -->
  <div id="customConfirmModalOverlay" class="custom-prompt-overlay">
      <div id="customConfirmModal" class="custom-prompt">
          <p id="customConfirmMessage"></p>
          <div class="button-group">
              <button id="customConfirmCancelButton" class="secondary-action">取消</button>
              <button id="customConfirmOkButton" class="primary-action">確定</button>
          </div>
      </div>
  </div>

  <!-- 通用提示 Modal (取代 alert) -->
  <div id="customAlertModalOverlay" class="custom-prompt-overlay">
      <div id="customAlertModal" class="custom-prompt">
          <p id="customAlertMessage"></p>
          <div class="button-group">
              <button id="customAlertOkButton" class="primary-action">我知道了</button>
          </div>
      </div>
  </div>

  <footer class="footer">
    <p>Copyright © 2025 發一崇德台中道場</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.js"></script>
  <script src="./zh-tw.js"></script>
  <script src="pwa-notifications.js" defer></script> 
  <script src="budaCards.js" defer></script> 
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        // !!! 重要：部署到 GitHub Pages 等子路徑時，請設為 '/your-repo-name/'，例如 '/jigong-news/' !!!
        // 本地開發時通常設為 '' (空字串)
        const PWA_SUB_PATH = ''; 

        const dom = {
            contentContainer: document.getElementById("content"),
            searchInput: document.getElementById("search"),
            datePickerInput: document.getElementById("datePicker"),
            loadMoreBtn: document.getElementById("loadMoreBtn"),
            resetBtn: document.getElementById("resetBtn"),
            todayBtn: document.getElementById("todayBtn"),
            imageModal: document.getElementById("imageModal"),
            modalImage: document.getElementById("modalImage"),
            modalCloseBtn: document.getElementById("modalCloseBtn"),
            modalPrevBtn: document.getElementById("modalPrevBtn"),
            modalNextBtn: document.getElementById("modalNextBtn"),
            shareButtonsContainer: document.getElementById("shareButtonsContainer"),
            layoutOptionsContainer: document.getElementById('layout-options'),
            gachaGameContainer: document.getElementById('gacha-game-container'),
        };

        let allPosts = [], filteredPosts = [], datePickerInstance = null, renderIndex = 0;
        const batchSize = 10;
        let imageList = [], currentImageIndex = -1;
        let shareButtonsTimeout = null;
        const shareButtonHideDelay = 3000;
        let modalNavButtonsTimeout = null;
        const modalNavButtonHideDelay = 2000;
        let touchStartX = 0;
        let touchEndX = 0;
        const swipeThreshold = 50;
        
        /**
         * 根據圖片路徑判斷是否為絕對路徑，並添加正確的圖片 URL 前綴。
         * 專為 GitHub Pages 上的原始檔案路徑設計。
         * @param {string} imagePath - 原始圖片路徑 (可能是絕對 URL 或相對路徑)。
         * @returns {string} 處理後的完整圖片 URL。
         */
        function getImageUrl(imagePath) {
            if (!imagePath) return "";
            if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
                return imagePath.replace(/\\/g, '/'); // Ensure forward slashes
            }
            const githubUsername = 'WANG-WEI-HAO'; // <--- 請在這裡替換為您的 GitHub 用戶名
            const githubRepoName = PWA_SUB_PATH.replace(/^\/|\/$/g, ''); // Remove leading/trailing slashes
            const githubBranch = 'main'; 
            const rawGithubBaseUrl = `https://raw.githubusercontent.com/${githubUsername}/${githubRepoName}/${githubBranch}/`;
            return new URL(imagePath.replace(/\\/g, '/').replace(/^\//, ''), rawGithubBaseUrl).href;
        }
        
        /**
         * 渲染批次文章到 DOM 中。
         */
        function renderBatch() {
            const postsToRender = filteredPosts.slice(renderIndex, renderIndex + batchSize);
            postsToRender.forEach(post => {
                const div = document.createElement("div"); 
                div.className = "post";
                const imgTag = post.image ? `<img src="${getImageUrl(post.image)}" alt="圖片" onerror="this.style.display='none';">` : "";
                const displayTextForRender = (post.text || "").replace(/\n/g, "<br>");
                
                div.innerHTML = `<div class="date">${post.date || ""}</div><div class="text"></div>${imgTag}`;
                const textElement = div.querySelector('.text');
                if (textElement) { 
                    textElement.innerHTML = displayTextForRender; 
                }
                dom.contentContainer.appendChild(div);
            });
            renderIndex += postsToRender.length;
            dom.loadMoreBtn.style.display = renderIndex >= filteredPosts.length ? "none" : "block";
        }

        /**
         * 重新渲染所有文章，清空現有內容並從頭開始渲染批次。
         * @param {Array<Object>} posts - 要渲染的文章數組。
         */
        function render(posts) { 
            dom.contentContainer.innerHTML = ""; 
            renderIndex = 0; 
            renderBatch(); 
        }

        /**
         * 從所有文章中獲取所有不重複的日期並排序。
         * @param {Array<Object>} posts - 所有文章數組。
         * @returns {Array<string>} 排序後的日期數組。
         */
        function getAllDates(posts) { 
            return [...new Set(posts.map(post => post.date).filter(Boolean))]
                   .sort((a, b) => (b || "").localeCompare(a || "")); 
        }
        
        /**
         * 從 posts.json 檔案獲取資料並渲染。
         */
        function fetchAndRender() {
            const postsJsonUrl = new URL('posts.json', window.location.origin + PWA_SUB_PATH).href;
            fetch(postsJsonUrl)
                .then(res => res.ok ? res.json() : Promise.reject(`HTTP Error: ${res.status}`))
                .then(data => {
                    allPosts = data;
                    filteredPosts = allPosts; 
                    render(filteredPosts);
              
                    if (datePickerInstance) datePickerInstance.destroy();
                    datePickerInstance = flatpickr(dom.datePickerInput, { 
                        dateFormat: "Y-m-d", disableMobile: true, locale: "zh_tw",
                        onChange: filterAndRender, enable: getAllDates(allPosts)
                    });

                    // Pass window.showCustomAlert to budaCards.js if it exists, otherwise use native alert
                    const alertFunction = typeof window.showCustomAlert === 'function' ? window.showCustomAlert : alert;

                    if (typeof initializeBudaCardsLogic === 'function') {
                        initializeBudaCardsLogic({
                            container: dom.gachaGameContainer,
                            allPosts: allPosts,
                            getImageUrl: getImageUrl,
                            showCustomAlert: alertFunction,
                            showModal: showModal,
                            PWA_SUB_PATH: PWA_SUB_PATH
                        });
                    } else {
                        console.error("錯誤: 找不到 initializeBudaCardsLogic 函數。budaCards.js 是否正確載入？");
                    }
                })
                .catch(error => { 
                    console.error("載入文章錯誤:", error); 
                    dom.contentContainer.innerHTML = `<p>無法載入文章，請稍後再試。<br>錯誤訊息: ${error.message}</p>`; 
                });
        }

        /**
         * 根據搜尋關鍵字和日期篩選文章並重新渲染。
         */
        function filterAndRender() {
            const keywordInput = dom.searchInput.value.trim().toLowerCase();
            const keywords = keywordInput.split(/\s+/).filter(Boolean); 
            const date = dom.datePickerInput.value.trim();

            filteredPosts = allPosts.filter(post => {
                const postText = (post.text || "").toLowerCase(); 
                const postDate = (post.date || "");
                const matchText = keywords.length === 0 || keywords.every(kw => postText.includes(kw));
                const matchDate = !date || postDate === date; 
                return matchText && matchDate;
            });
            render(filteredPosts);
        }

        /** 更新圖片列表 (當篩選或載入更多時，圖片可能會變動) */
        function updateImageList() { 
          imageList = filteredPosts.filter(post => post.image).map(post => getImageUrl(post.image));
        }

        /** 顯示分享按鈕容器 */
        function showShareButtons() {
            if (dom.shareButtonsContainer) { 
                dom.shareButtonsContainer.classList.add('visible'); 
                clearTimeout(shareButtonsTimeout);
                shareButtonsTimeout = setTimeout(hideShareButtons, shareButtonHideDelay);
            }
        }

        /** 隱藏分享按鈕容器 */
        function hideShareButtons() { 
            if (dom.shareButtonsContainer) { 
              dom.shareButtonsContainer.classList.remove('visible'); 
            }
        }

        /** 顯示模態視窗導航按鈕 (上一張/下一張) */
        function showModalNavButtons() {
            if (dom.modalPrevBtn && dom.modalNextBtn && dom.imageModal.style.display === "flex") { 
                dom.modalPrevBtn.classList.add('visible');
                dom.modalNextBtn.classList.add('visible');
                clearTimeout(modalNavButtonsTimeout);
                modalNavButtonsTimeout = setTimeout(hideModalNavButtons, modalNavButtonHideDelay);
            }
        }

        /** 隱藏模態視窗導航按鈕 */
        function hideModalNavButtons() {
            if (dom.modalPrevBtn && dom.modalNextBtn) { 
                dom.modalPrevBtn.classList.remove('visible');
                dom.modalNextBtn.classList.remove('visible');
            }
        }
        
        /**
         * 生成並顯示分享按鈕。
         * @param {string} imageUrl - 要分享的圖片 URL。
         * @param {string} [postText=""] - 關聯的文章文字內容。
         */
        function generateShareButtons(imageUrl, postText = "") {
            if (!dom.shareButtonsContainer) return;

            dom.shareButtonsContainer.innerHTML = ''; 
            const siteToShareUrl = "https://sites.google.com/view/fycd-tc/%E6%BF%9F%E5%85%AC%E5%A0%B1";
            const encodedSiteToShareUrl = encodeURIComponent(siteToShareUrl);
            const shareTextContent = postText ? postText.substring(0, 100) + (postText.length > 100 ? "..." : "") : document.title;
            const lineShareText = encodeURIComponent(`${shareTextContent}\n${siteToShareUrl}`);

            const shares = [
                {
                    name: 'Facebook',
                    action: (event) => {
                        event.stopPropagation(); 
                        showShareButtons(); 
                        const fbShareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodedSiteToShareUrl}`;
                        window.open(fbShareUrl, '_blank', 'noopener,noreferrer');
                    },
                    icon: 'ICON/facebook.png'
                },
                { 
                    name: 'Line', 
                    action: (event) => { 
                        event.stopPropagation(); 
                        showShareButtons(); 
                        window.open(`line://msg/text/?${lineShareText}`, '_blank'); 
                    }, 
                    icon: 'ICON/line.png' 
                },
                { 
                    name: '複製連結', 
                    action: async (event) => { 
                        event.stopPropagation(); 
                        showShareButtons(); 
                        const btn = event.currentTarget;
                        const textToCopy = `網站連結：${siteToShareUrl}\n圖片連結：${imageUrl}`;
                        try {
                            await navigator.clipboard.writeText(textToCopy);
                            if (typeof window.showCustomAlert === 'function') {
                                window.showCustomAlert('連結已複製！');
                            } else {
                                alert('連結已複製！');
                            }
                            if (btn) { 
                                const orig = btn.innerHTML; 
                                btn.innerHTML = '✅ 已複製'; 
                                setTimeout(() => { 
                                  if (btn.parentNode) { 
                                    btn.innerHTML = orig; 
                                  }
                                }, 1500); 
                            }
                        } catch (err) { 
                            console.error('無法複製連結: ', err); 
                            if (typeof window.showCustomAlert === 'function') {
                                window.showCustomAlert('複製連結失敗。請手動複製以下內容：\n' + textToCopy);
                            } else {
                                alert('複製連結失敗。請手動複製以下內容：\n' + textToCopy);
                            }
                        }
                    }, 
                    icon: 'ICON/link.png'
                }
            ];

            shares.forEach(share => {
                const element = share.url ? document.createElement('a') : document.createElement('button');
                const iconSrc = getImageUrl(share.icon);
                element.innerHTML = `<img src="${iconSrc}" alt="${share.name}" class="share-btn-icon">`; 
                element.title = share.title || `分享到 ${share.name}`;
                if (share.className) element.classList.add(share.className);
                if (share.action) element.addEventListener('click', share.action); 
                dom.shareButtonsContainer.appendChild(element);
            });
            showShareButtons();
        }

        /**
         * 顯示圖片模態視窗。
         * @param {string} clickedImgSrc - 被點擊的圖片 src。
         * @param {number} [specificIndex] - 如果傳入此參數，則直接顯示該索引的圖片。
         */
        function showModal(clickedImgSrc, specificIndex = -1) {
            updateImageList(); 
            const index = specificIndex !== -1 ? specificIndex : imageList.indexOf(clickedImgSrc); 
            if (index === -1) {
              console.warn("無法找到圖片在 imageList 中，可能影響導航功能。", clickedImgSrc);
              dom.modalImage.src = clickedImgSrc;
              currentImageIndex = -1;
            } else {
              currentImageIndex = index;
              dom.modalImage.src = imageList[currentImageIndex];
            }

            dom.imageModal.style.display = "flex";
            document.body.style.overflow = 'hidden';

            const originalPost = allPosts.find(p => getImageUrl(p.image) === dom.modalImage.src);
            let postTextForShare = originalPost && originalPost.text ? originalPost.text : "";
            
            generateShareButtons(dom.modalImage.src, postTextForShare);
            showModalNavButtons();
        }

        /** 隱藏圖片模態視窗。 */
        function hideModal() {
            dom.imageModal.style.display = "none";
            document.body.style.overflow = 'auto';
            currentImageIndex = -1;
            clearTimeout(shareButtonsTimeout); 
            hideShareButtons();
            clearTimeout(modalNavButtonsTimeout); 
            hideModalNavButtons();
        }
        
        /**
         * 導航到上一張或下一張圖片。
         * @param {number} direction - 1 為下一張，-1 為上一張。
         */
        function navigateModalImage(direction) {
            if (currentImageIndex === -1 || imageList.length === 0) {
              console.log("無法導航：無當前圖片或圖片列表為空。");
              return;
            }

            currentImageIndex += direction;
            if (currentImageIndex < 0) {
              currentImageIndex = imageList.length - 1; 
            } else if (currentImageIndex >= imageList.length) {
              currentImageIndex = 0; 
            }
            
            dom.modalImage.src = imageList[currentImageIndex];

            const originalPost = allPosts.find(p => getImageUrl(p.image) === dom.modalImage.src);
            let postTextForShare = originalPost && originalPost.text ? originalPost.text : "";
            generateShareButtons(dom.modalImage.src, postTextForShare);
            showModalNavButtons();
        }
        
        // --- 事件監聽器 ---
        dom.searchInput.addEventListener("input", filterAndRender);
        dom.loadMoreBtn.addEventListener("click", renderBatch);
        dom.resetBtn.addEventListener("click", function() {
          dom.searchInput.value = ""; 
          dom.datePickerInput.value = "";
          if (datePickerInstance) {
            datePickerInstance.clear(); 
          }
          filterAndRender();
        });
        
        dom.todayBtn.addEventListener("click", () => {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        dom.contentContainer.addEventListener("click", e => {
            if (e.target.tagName === "IMG" && e.target.closest(".post")) showModal(e.target.src);
        });

        if (dom.imageModal) {
            dom.imageModal.addEventListener('click', (event) => { 
                if (event.target === dom.imageModal) { hideModal(); }
            });
            dom.imageModal.addEventListener('mousemove', () => { 
                if(dom.imageModal.style.display === "flex") { 
                    showShareButtons(); 
                    showModalNavButtons(); 
                } 
            });
            dom.imageModal.addEventListener('touchstart', (e) => { 
                if (e.touches.length === 1) { 
                    touchStartX = e.touches[0].clientX; 
                    touchEndX = 0; 
                }
            }, { passive: true });
            dom.imageModal.addEventListener('touchmove', (e) => { 
                if (e.touches.length === 1) {
                    touchEndX = e.touches[0].clientX; 
                }
            }, { passive: true });
            dom.imageModal.addEventListener('touchend', () => {
                if (touchEndX === 0 || Math.abs(touchStartX - touchEndX) < swipeThreshold) {
                    showShareButtons(); 
                    showModalNavButtons(); 
                    return;
                }
                if (touchEndX < touchStartX) { navigateModalImage(1); } // Swipe left (next)
                else if (touchEndX > touchStartX) { navigateModalImage(-1); } // Swipe right (prev)
                touchStartX = 0; 
                touchEndX = 0;
            });
        }
        
        if (dom.modalImage) { dom.modalImage.addEventListener('click', (e) => { e.stopPropagation(); showShareButtons(); showModalNavButtons(); }); }
        if (dom.modalCloseBtn) { dom.modalCloseBtn.addEventListener('click', hideModal); }
        if (dom.modalPrevBtn) { dom.modalPrevBtn.addEventListener('click', (e) => { e.stopPropagation(); navigateModalImage(-1); }); }
        if (dom.modalNextBtn) { dom.modalNextBtn.addEventListener('click', (e) => { e.stopPropagation(); navigateModalImage(1); }); }

        document.addEventListener("keydown", function (e) {
            const modalVisible = dom.imageModal.style.display === "flex";
            if (!modalVisible) return;
            if (e.key === "Escape") { hideModal(); } 
            else if (e.key === "ArrowRight") { navigateModalImage(1); } 
            else if (e.key === "ArrowLeft") { navigateModalImage(-1); }
        });

        // --- 排版設定 ---
        function applyLayoutPreference() {
            let preferredLayout = localStorage.getItem('preferredLayout') || 'layout-2-col';
            document.body.className = document.body.className.replace(/layout-\d-col/g, '').trim();
            document.body.classList.add(preferredLayout);
            dom.layoutOptionsContainer.querySelectorAll('.layout-option-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.layout === preferredLayout);
            });
        }
        dom.layoutOptionsContainer.addEventListener('click', e => {
            if (e.target.classList.contains('layout-option-btn')) {
                localStorage.setItem('preferredLayout', e.target.dataset.layout);
                applyLayoutPreference();
            }
        });

        applyLayoutPreference(); // Initial application of layout preference
        fetchAndRender(); // Fetch and render posts

        // PWA Logic Initialization (傳遞 DOM 元素給 pwa-notifications.js)
        if (typeof initializePwaLogic === 'function') {
            initializePwaLogic({
                settingsBtn: document.getElementById('settings-btn'),
                settingsPanel: document.getElementById('settings-panel'),
                closeSettingsBtn: document.getElementById('close-settings-btn'),
                notificationToggleSwitch: document.getElementById('notificationToggle'),
                notificationLabel: document.querySelector('label[for="notificationToggle"]'),
                themeToggleSwitch: document.getElementById('themeToggleSwitch'),
                clearCacheBtn: document.getElementById('clear-cache-btn'),
                overlay: document.querySelector('.overlay'),
                customInstallPromptOverlay: document.getElementById('customInstallPromptOverlay'),
                notificationConfirmationModalOverlay: document.getElementById('notificationConfirmationModalOverlay'),
                notificationConfirmationModal: document.getElementById('notificationConfirmationModal'),
                permissionDeniedModalOverlay: document.getElementById('permissionDeniedModalOverlay'),
                permissionDeniedModal: document.getElementById('permissionDeniedModal'),
                customConfirmModalOverlay: document.getElementById('customConfirmModalOverlay'),
                customAlertModalOverlay: document.getElementById('customAlertModalOverlay'),
                PWA_SUB_PATH: PWA_SUB_PATH // Pass PWA_SUB_PATH to PWA logic script
            });
        } else {
            console.error("錯誤: 找不到 initializePwaLogic 函數。");
        }
    });
  </script>
</body>
</html>